version: 2.1

orbs:
  node: circleci/node@7.2.1

jobs:
  checkoutEtTests:
    executor:
      name: node/default
      tag: lts
    steps:
      - run:
          name: Cloner le repo backend (git clone)
          command: |
            git clone https://github.com/ernfaus24/3w5-h25-L01-backend.git 3w5-h25-L01-backend

      - run:
          name: Installer dépendances + exécuter tests (multi-ligne)
          command: |
            cd 3w5-h25-L01-backend
            npm install
            npm run test

  integrationFrontend:
    executor:
      name: node/default
      tag: lts
    steps:
      - run:
          name: Cloner backend puis frontend (git clone)
          command: |
            git clone https://github.com/ernfaus24/3w5-h25-L01-backend.git 3w5-h25-L01-backend
            git clone https://github.com/ernfaus24/3w5-h25-L01-frontend.git 3w5-h25-L01-frontend

      - run:
          name: Installer + build frontend (multi-ligne)
          command: |
            cd 3w5-h25-L01-frontend
            npm install
            npm run build

      - run:
          name: Créer backend/public et copier le build (cp -rT)
          command: |
            mkdir -p 3w5-h25-L01-backend/public
            cp -rT 3w5-h25-L01-frontend/build 3w5-h25-L01-backend/public

      - persist_to_workspace:
          root: .
          paths:
            - 3w5-h25-L01-backend

  deploiement:
    executor:
      name: node/default
      tag: lts
    steps:
      - attach_workspace:
          at: .

      - run:
          name: Vérifier le contenu prêt au déploiement (ls -Rl)
          command: |
            cd 3w5-h25-L01-backend
            ls -Rl

workflows:
  pipeline-integration:
    jobs:
      - checkoutEtTests
      - integrationFrontend:
          requires:
            - checkoutEtTests
      - deploiement:
          requires:
            - integrationFrontend
